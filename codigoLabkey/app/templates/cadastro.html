{% extends "authBase.html" %}

{% block title %}Cadastro de Usuário{% endblock %}

{% block header_title %}Cadastro{% endblock %}

{% block header_description %}Comece agora a gerenciar suas reservas{% endblock %}

{% block content %}
<form
  class="form-stl"
  id="cadastro-form" 
  method="POST"
>
  <div class="row">
    <div class="mb-3 col-md-12">
      <label for="nome" class="form-label">Nome</label>
      <input
        type="text"
        class="form-control"
        id="nome"
        name="nome"
        required
      />
    </div>
  </div>
  <div class="row">
    <div class="mb-3 col-md-12">
      <label for="email" class="form-label">Endereço de Email</label>
      <input
        type="email"
        class="form-control"
        id="email"
        name="email"
        required
      />
    </div>
  </div>

  <div class="row">
    <div class="mb-3 col-md-6">
      <label for="senha" class="form-label">Senha</label>
      <input
        type="password"
        class="form-control"
        id="senha"
        name="senha"
        required
      />
    </div>
    <div class="mb-3 col-md-6">
      <label for="tipoUsuario" class="form-label"
        >Perfil de usuário</label
      >
      <select
        class="form-select"
        id="perfil" 
        name="perfil" 
        required
      >
        <option value="" selected disabled>Selecione seu perfil</option>
        <option value="Aluno">Aluno</option>
        <option value="Servidor">Servidor</option>
        <option value="Funcionario">Funcionario</option>
        <option value="Administrador">Administrador</option>
      </select>
    </div>
  </div>

  <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
  <p class="mt-3 text-center">Já tem conta? <a href="/login">Faça Login</a></p>
</form>
{% endblock %}

{% block page_script %}
<script>
  document.getElementById('cadastro-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const data = {};
    
    formData.forEach((value, key) => {
      data[key] = value;
    });

    data['perfil'] = document.getElementById('perfil').value; 
    
    const feedbackDiv = document.getElementById('feedback-message');
    feedbackDiv.innerHTML = ''; 
    
    // ATENÇÃO: Mantenha o endereço correto da sua API!
    const API_URL = "http://127.0.0.1:8000/cadastro"; 

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (response.ok) {
        feedbackDiv.innerHTML = `<div class="alert alert-success" role="alert"><strong>Sucesso!</strong> ${result.mensagem}</div>`;
        form.reset();
        // Redireciona para o login após sucesso
        setTimeout(() => { window.location.href = '/login'; }, 2000); 
      } else {
        const errorMessage = result.detail || result.mensagem || "Ocorreu um erro desconhecido.";
        feedbackDiv.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Erro:</strong> ${errorMessage}</div>`;
      }

    } catch (error) {
      console.error('Erro na comunicação com a API:', error);
      feedbackDiv.innerHTML = `<div class="alert alert-danger" role="alert">Erro de conexão: Não foi possível alcançar o servidor.</div>`;
    }
  });
</script>
{% endblock %}