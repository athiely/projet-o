{% extends "authBase.html" %}

{% block title %}Login - LabKey{% endblock %}

{% block auth_content %}
<div class="form-container">
    <div class="auth-txt">
        <h1>Login</h1>
        <p>Entre para acessar suas reservas</p>
        <!-- Div para exibir mensagens de sucesso ou erro -->
        <div id="feedback-message" class="mt-3"></div> 
    </div>

    <form class="form-stl" id="login-form">
        <div class="row">
            <div class="mb-3 col-md-12">
                <label for="email-log" class="form-label">Endereço de Email</label>
                <input
                    type="email"
                    class="form-control"
                    id="email-log"
                    name="email"
                    required
                />
            </div>
        </div>

        <div class="row">
            <div class="mb-3 col-md-12">
                <label for="senha-log" class="form-label">Senha</label>
                <input
                    type="password"
                    class="form-control"
                    id="senha-log"
                    name="senha"
                    required
                />
            </div>
        </div>

        <button type="submit" class="btn w-100" id="login-btn">Entrar</button>
        <p class="mt-3 text-center">
            Não tem conta? <a href="/cadastro">Cadastre-se</a>
        </p>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = "/api/v1";

    /** Exibe mensagens de feedback (Sucesso ou Erro) */
    function showFeedback(message, type = 'success') {
        const feedbackDiv = document.getElementById('feedback-message');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        
        feedbackDiv.innerHTML = `
            <div class="alert-custom ${alertClass}" role="alert">
                ${message}
            </div>
        `;
    }

    /** Lida com o envio do formulário de Login */
    async function handleLoginSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const submitBtn = document.getElementById('login-btn');
        
        const data = { 
            email: form.email.value, 
            senha: form.senha.value
        };
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Aguarde...';
        document.getElementById('feedback-message').innerHTML = '';

        try {
            // Esta é a simulação da chamada real de API: POST para /api/v1/login
            const response = await fetch(`${API_BASE}/login`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(data) 
            });
            
            const result = await response.json(); // Tenta ler o JSON do backend

            if (response.ok) {
                // Sucesso: Backend deve retornar uma mensagem ou token
                showFeedback(result.mensagem || `Login efetuado com sucesso! Redirecionando...`, 'success');
                setTimeout(() => { 
                    // Em uma aplicação real, você usaria o token retornado para autenticar o usuário 
                    window.location.href = '/dashboard'; 
                }, 1000); 
            } else {
                // Falha: Exibe a mensagem de erro do backend (ex: credenciais inválidas)
                showFeedback(result.detail || result.mensagem || "Credenciais inválidas. Tente novamente.", 'danger');
            }
        } catch (error) {
            console.error('Erro de Conexão ou Servidor:', error);
            showFeedback("Não foi possível conectar ao servidor. Verifique se o backend está rodando.", 'danger');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Entrar';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
    });
</script>
{% endblock %}