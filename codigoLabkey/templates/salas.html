{% extends "base_dashboard.html" %} {% block content %}

<style>
  .lab_cad_btn .btn {
    background-color: #03bf63;
    color: white;
    border-color: #03bf63;
    transition: transform 0.2s;
  }

  .lab_cad_btn .btn:hover {
    background-color: #00944c;
    border-color: #00944c;
    color: white;
    transform: scale(1.03);
  }

  .edt-btn {
    background-color: #fff743;
    color: #333;
    border-color: #fff743;
  }

  .edt-btn:hover {
    background-color: #e4dc2e;
    color: #333;
    border-color: #e4dc2e;
  }

  .modal-footer .exc-btn {
    background-color: #ff6464;
    color: white;
    border-color: #ff6464;
  }

  .modal-footer .exc-btn:hover {
    background-color: #ff4545;
    border-color: #ff4545;
  }

  .card-sala {
    cursor: pointer;
    transition: transform 0.2s;
    aspect-ratio: 1 / 1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    background-color: #03bf63 !important;
    color: white !important;
  }

  .card-sala:hover {
    transform: scale(1.03);
  }

  .modal-footer .save-btn {
    background-color: #03bf63;
    border-color: #03bf63;
    color: white;
  }

  .modal-footer .save-btn:hover {
    background-color: #00944c;
    border-color: #00944c;
  }
</style>

<div class="container my-5">
  <h2 class="text-center mb-5">Salas e Laboratorios</h2>

  <div class="lab_cad_btn d-flex justify-content-end mb-4">
    {% if tipo_usuario == 'ADMINISTRADOR' %}
    <button
      class="btn"
      type="button"
      data-coreui-toggle="modal"
      data-coreui-target="#modalCadastroSala"
    >
      <i class="c-icon cil-plus"></i> Nova Sala
    </button>
    {% endif %}
  </div>

  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-4">
    {% for sala in salas %}
    <div class="col">
      <div
        class="card card-sala text-center border-0"
        style="cursor: pointer; min-height: 150px"
        data-sala-id="{{ sala.id }}"
        data-sala-nome="{{ sala.nome }}"
        data-sala-capacidade="{{ sala.capacidade }}"
        data-sala-localizacao="{{ sala.localizacao or 'Não Informada' }}"
        data-sala-recursos="{{ sala.recursos or 'Nenhum' }}"
        data-sala-descricao="{{ sala.descricao or 'Nenhuma descrição fornecida.' }}"
        data-coreui-toggle="modal"
        data-coreui-target="#modalDetalhesSala"
      >
        <div class="card-body d-flex align-items-center justify-content-center">
          <h5 class="card-title mb-0 text-white">{{ sala.nome }}</h5>
        </div>
      </div>
    </div>
    {% endfor %} {% if not salas %}
    <div class="col-12">
      <p class="text-center text-muted mt-5">Ainda não há salas cadastradas.</p>
    </div>
    {% endif %}
  </div>

  <div
    class="modal fade"
    id="modalCadastroSala"
    tabindex="-1"
    aria-labelledby="modalCadastroSalaLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="formCadastroSala">
          <div class="modal-header">
            <h5 class="modal-title" id="modalCadastroSalaLabel">
              Cadastrar Nova Sala
            </h5>
            <button
              class="btn-close"
              type="button"
              data-coreui-dismiss="modal"
              aria-label="Fechar"
            ></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="nome" class="form-label">Nome da Sala:</label>
              <input
                class="form-control"
                id="nome"
                name="nome"
                type="text"
                placeholder="Ex: M1, Lab Química"
                required
              />
            </div>

            <div class="mb-3">
              <label for="capacidade" class="form-label"
                >Capacidade Máxima:</label
              >
              <input
                class="form-control"
                id="capacidade"
                name="capacidade"
                type="number"
                min="1"
                placeholder="Ex: 30"
                required
              />
            </div>

            <div class="mb-3">
              <label for="localizacao" class="form-label"
                >Localização (Bloco):</label
              >
              <input
                class="form-control"
                id="localizacao"
                name="localizacao"
                type="text"
                placeholder="Ex: Bloco A, Prédio Principal"
              />
            </div>

            <div class="mb-3">
              <label for="descricao" class="form-label">Descrição:</label>
              <textarea
                class="form-control"
                id="descricao"
                name="descricao"
                rows="3"
                placeholder="Ex: Laboratório de informática com 30 PCs."
              ></textarea>
            </div>

            <div class="mb-3">
              <label for="recursos" class="form-label">Recursos:</label>
              <input
                class="form-control"
                id="recursos"
                name="recursos"
                type="text"
                placeholder="Ex: Projetor, Quadro Branco, Ar Condicionado"
              />
            </div>
          </div>

          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              type="button"
              data-coreui-dismiss="modal"
            >
              Fechar
            </button>
            <button class="btn save-btn" type="submit">Salvar Sala</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div
    class="modal fade"
    id="modalDetalhesSala"
    tabindex="-1"
    aria-labelledby="modalDetalhesSalaLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalDetalhesSalaLabel">
            <span id="detalheNomeModal"></span>
          </h5>
          <button
            class="btn-close"
            type="button"
            data-coreui-dismiss="modal"
            aria-label="Fechar"
          ></button>
        </div>

        <div class="modal-body">
          <p><strong>Nome:</strong> <span id="detalheNome"></span></p>
          <p><strong>Descrição:</strong> <span id="detalheDescricao"></span></p>
          <p>
            <strong>Capacidade:</strong> <span id="detalheCapacidade"></span>
          </p>
          <p><strong>Recursos:</strong> <span id="detalheRecursos"></span></p>
          <p>
            <strong>Localização:</strong> <span id="detalheLocalizacao"></span>
          </p>
        </div>

        <div class="modal-footer">
          {% if tipo_usuario == 'ADMINISTRADOR' %}
          <button class="btn edt-btn" id="btnEditarSala">Editar</button>
          <button class="btn exc-btn" id="btnExcluirSala">Excluir</button>
          {% endif %}
          <button
            class="btn btn-secondary"
            type="button"
            data-coreui-dismiss="modal"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEdicaoSala" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="formEdicaoSala">
          <div class="modal-header">
            <h5 class="modal-title">
              Editar Sala: <span id="edicaoNomeTitulo"></span>
            </h5>
            <button
              class="btn-close"
              type="button"
              data-coreui-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nome:</label>
              <input class="form-control" id="editNome" name="nome" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Capacidade:</label>
              <input
                class="form-control"
                id="editCapacidade"
                name="capacidade"
                type="number"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Localização:</label>
              <input
                class="form-control"
                id="editLocalizacao"
                name="localizacao"
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Descrição:</label>
              <textarea
                class="form-control"
                id="editDescricao"
                name="descricao"
              ></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Recursos:</label>
              <input class="form-control" id="editRecursos" name="recursos" />
            </div>
          </div>

          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              type="button"
              data-coreui-dismiss="modal"
            >
              Cancelar
            </button>
            <button class="btn save-btn" type="submit">
              Salvar alterações
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalConfirmacaoExclusao" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Exclusão</h5>
          <button
            class="btn-close"
            type="button"
            data-coreui-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            Tem certeza que deseja excluir a sala
            <strong><span id="nomeSalaExclusao"></span></strong>?
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            type="button"
            data-coreui-dismiss="modal"
          >
            Cancelar
          </button>
          <button class="btn exc-btn" id="confirmarExclusao">
            Excluir Permanentemente
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}

<script>
  let salaAtivaId = null;

  function showCoreUIModal(modalId) {
    const modalEl = document.getElementById(modalId);
    const modal =
      coreui.Modal.getInstance(modalEl) || new coreui.Modal(modalEl);
    modal.show();
  }

  function hideCoreUIModal(modalId) {
    const modalEl = document.getElementById(modalId);
    const modal = coreui.Modal.getInstance(modalEl);
    if (modal) {
      modal.hide();
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const detalhesModal = document.getElementById("modalDetalhesSala");
    const btnEditarSala = document.getElementById("btnEditarSala");
    const btnExcluirSala = document.getElementById("btnExcluirSala");
    const modalExclusao = document.getElementById("modalConfirmacaoExclusao");
    const btnConfirmarExclusao = document.getElementById("confirmarExclusao");

    const formCadastro = document.getElementById("formCadastroSala");
    if (formCadastro) {
      formCadastro.addEventListener("submit", async function (event) {
        event.preventDefault();
        const formData = new FormData(formCadastro);
        const data = {};
        formData.forEach(
          (value, key) =>
            (data[key] = key === "capacidade" ? parseInt(value) : value || null)
        );

        try {
          const response = await fetch("/api/v1/salas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || `Erro HTTP ${response.status}`);
          }

          const result = await response.json();
          alert(`Sala "${result.nome}" cadastrada com sucesso!`);
          hideCoreUIModal("modalCadastroSala");
          window.location.reload();
        } catch (err) {
          console.error(err);
          alert("Falha no cadastro: " + (err.message || "Erro desconhecido."));
        }
      });
    }

    if (detalhesModal) {
      detalhesModal.addEventListener("show.coreui.modal", function (event) {
        const card = event.relatedTarget;

        salaAtivaId = card.getAttribute("data-sala-id");

        const nome = card.getAttribute("data-sala-nome");
        const capacidade = card.getAttribute("data-sala-capacidade");
        const localizacao = card.getAttribute("data-sala-localizacao");
        const recursos = card.getAttribute("data-sala-recursos");
        const descricao = card.getAttribute("data-sala-descricao");

        document.getElementById("detalheNomeModal").textContent = nome;
        document.getElementById("detalheNome").textContent = nome;
        document.getElementById("detalheCapacidade").textContent =
          capacidade + " pessoas";
        document.getElementById("detalheLocalizacao").textContent = localizacao;
        document.getElementById("detalheRecursos").textContent = recursos;
        document.getElementById("detalheDescricao").textContent = descricao;

        if (btnEditarSala) {
          btnEditarSala.setAttribute("data-sala-id", salaAtivaId);
          btnEditarSala.setAttribute("data-sala-nome", nome);
          btnEditarSala.setAttribute("data-sala-capacidade", capacidade);
          btnEditarSala.setAttribute("data-sala-localizacao", localizacao);
          btnEditarSala.setAttribute("data-sala-recursos", recursos);
          btnEditarSala.setAttribute("data-sala-descricao", descricao);
        }

        if (btnExcluirSala) {
          btnExcluirSala.setAttribute("data-sala-nome", nome);
          btnExcluirSala.onclick = () =>
            showCoreUIModal("modalConfirmacaoExclusao");
        }
      });
    }

    if (modalExclusao) {
      modalExclusao.addEventListener("show.coreui.modal", function () {
        const nomeSala = btnExcluirSala.getAttribute("data-sala-nome");
        document.getElementById("nomeSalaExclusao").textContent = nomeSala;

        hideCoreUIModal("modalDetalhesSala");
      });
    }

    if (btnConfirmarExclusao) {
      btnConfirmarExclusao.addEventListener("click", async function () {
        if (!salaAtivaId) return;

        const nomeSala =
          document.getElementById("nomeSalaExclusao").textContent;

        try {
          const response = await fetch(`/api/v1/salas/${salaAtivaId}`, {
            method: "DELETE",
          });

          if (response.status === 204) {
            alert(`Sala "${nomeSala}" excluída com sucesso.`);
            hideCoreUIModal("modalConfirmacaoExclusao");
            window.location.reload();
          } else {
            const err = await response.json();
            throw new Error(err.detail || `Erro HTTP ${response.status}`);
          }
        } catch (err) {
          console.error("Erro na exclusão:", err);
          alert(
            "Falha na exclusão da sala: " +
              (err.message || "Erro desconhecido.")
          );
          hideCoreUIModal("modalConfirmacaoExclusao");
        }
      });
    }

    if (btnEditarSala) {
      btnEditarSala.addEventListener("click", function () {
        hideCoreUIModal("modalDetalhesSala");
        const id = this.getAttribute("data-sala-id");
        const nome = this.getAttribute("data-sala-nome");
        const capacidade = this.getAttribute("data-sala-capacidade");
        const localizacao = this.getAttribute("data-sala-localizacao");
        const recursos = this.getAttribute("data-sala-recursos");
        const descricao = this.getAttribute("data-sala-descricao");

        document.getElementById("edicaoNomeTitulo").textContent = nome;
        document
          .getElementById("formEdicaoSala")
          .setAttribute("data-sala-id", id);

        document.getElementById("editNome").value = nome;
        document.getElementById("editCapacidade").value = capacidade;

        document.getElementById("editLocalizacao").value =
          localizacao === "Não Informada" ? "" : localizacao;
        document.getElementById("editRecursos").value =
          recursos === "Nenhum" ? "" : recursos;
        document.getElementById("editDescricao").value =
          descricao === "Nenhuma descrição fornecida." ? "" : descricao;

        showCoreUIModal("modalEdicaoSala");
      });
    }

    const formEdicao = document.getElementById("formEdicaoSala");
    if (formEdicao) {
      formEdicao.addEventListener("submit", async function (event) {
        event.preventDefault();
        const idParaEditar = this.getAttribute("data-sala-id");
        if (!idParaEditar)
          return alert("Erro: ID da sala não encontrado para edição.");

        const formData = new FormData(formEdicao);
        const data = {};
        formData.forEach(
          (value, key) =>
            (data[key] = key === "capacidade" ? parseInt(value) : value || null)
        );

        try {
          const response = await fetch(`/api/v1/salas/${idParaEditar}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || `Erro HTTP ${response.status}`);
          }

          const result = await response.json();
          alert(`Sala "${result.nome}" atualizada com sucesso!`);
          hideCoreUIModal("modalEdicaoSala");
          window.location.reload();
        } catch (err) {
          console.error("Erro na atualização:", err);
          alert(
            "Falha na atualização da sala: " +
              (err.message || "Erro desconhecido.")
          );
        }
      });
    }
  });
</script>

{% endblock %}
