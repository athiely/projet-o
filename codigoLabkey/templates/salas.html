{% extends "base_dashboard.html" %} 

{% block content %}

<style>
  /* Estilo para o bot√£o de Cadastro (Nova Sala) */
  .lab_cad_btn .btn {
    background-color: #03bf63;
    color: white; /* Adicionando cor branca ao texto para melhor contraste */
    border-color: #03bf63; /* Definindo a cor da borda igual √† do fundo */
  }

  /* Hover do bot√£o de Cadastro (Nova Sala) - Especificidade aumentada */
  .lab_cad_btn .btn:hover {
    background-color: #00944c;
    border-color: #00944c;
    transform: scale(1.03);
  }

  /* Estilo para o bot√£o de Edi√ß√£o (Geralmente √© .btn-warning) */
  .edt-btn {
    background-color: #fff743;
    color: #333; /* Cor do texto escuro para contraste */
    border-color: #fff743;
  }

  /* Hover do bot√£o de Edi√ß√£o */
  .edt-btn:hover {
    background-color: #e4dc2e;
    color: #333;
    border-color: #e4dc2e;
  }

  /* Estilo para o bot√£o de Exclus√£o (Geralmente √© .btn-danger) */
  .modal-footer .exc-btn {
    background-color: #ff6464;
    color: white;
    border-color: #ff6464;
  }

  /* Hover do bot√£o de Exclus√£o */
  .modal-footer .exc-btn:hover {
    background-color: #ff4545;
    border-color: #ff4545;
  }

  /* Estilos do Card Sala (Mantidos) */
  .card-sala {
    cursor: pointer;
    transition: transform 0.2s;
    aspect-ratio: 1 / 1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    background-color: #03bf63 !important; /* Adicionado !important para for√ßar a cor */
    color: white !important; /* Garante que o texto seja branco */
  }

  .card-sala:hover {
    transform: scale(1.03);
  }
  
  /* Sobrescrevendo o estilo padr√£o do .btn-primary */
  .modal-footer .save-btn {
    background-color: #03bf63;
    border-color: #03bf63;
    color: white;
  }

  /* Aplicando o hover no .btn-primary */
  .modal-footer .save-btn:hover {
    background-color: #00944c;
    border-color: #00944c;
  }
</style>

<div class="container my-5">
  <h2 class="text-center mb-5">Todas as Salas</h2>

  <div class="lab_cad_btn d-flex justify-content-end mb-4">
    {% if tipo_usuario == 'ADMINISTRADOR' %}
    <button
      class="btn"
      type="button"
      data-coreui-toggle="modal"
      data-coreui-target="#modalCadastroSala"
    >
      <i class="c-icon cil-plus"></i> Nova Sala
    </button>
    {% endif %}
  </div>

  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-4">

    {% for sala in salas %}
    <div class="col">
      <div
        class="card card-sala text-center border-0"
        style="cursor: pointer; min-height: 150px"
        data-sala-id="{{ sala.id }}"
        data-sala-nome="{{ sala.nome }}"
        data-sala-capacidade="{{ sala.capacidade }}"
        data-sala-localizacao="{{ sala.localizacao or 'N√£o Informada' }}"
        data-sala-recursos="{{ sala.recursos or 'Nenhum' }}"
        data-sala-descricao="{{ sala.descricao or 'Nenhuma descri√ß√£o fornecida.' }}"
        data-coreui-toggle="modal"
        data-coreui-target="#modalDetalhesSala"
      >
        <div class="card-body d-flex align-items-center justify-content-center">
          <h5 class="card-title mb-0 text-white">{{ sala.nome }}</h5> 
        </div>
      </div>
    </div>
    {% endfor %}

    {% if not salas %}
    <div class="col-12">
      <p class="text-center text-muted mt-5">Ainda n√£o h√° salas cadastradas.</p>
    </div>
    {% endif %}
  </div>

  <div class="modal fade" id="modalCadastroSala" tabindex="-1" aria-labelledby="modalCadastroSalaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="formCadastroSala">
          <div class="modal-header">
            <h5 class="modal-title" id="modalCadastroSalaLabel">üìù Cadastrar Nova Sala</h5>
            <button class="btn-close" type="button" data-coreui-dismiss="modal" aria-label="Fechar"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="nome" class="form-label">Nome da Sala:</label>
              <input class="form-control" id="nome" name="nome" type="text" placeholder="Ex: M1, Lab Qu√≠mica" required>
            </div>

            <div class="mb-3">
              <label for="capacidade" class="form-label">Capacidade M√°xima:</label>
              <input class="form-control" id="capacidade" name="capacidade" type="number" min="1" placeholder="Ex: 30" required>
            </div>

            <div class="mb-3">
              <label for="localizacao" class="form-label">Localiza√ß√£o (Bloco):</label>
              <input class="form-control" id="localizacao" name="localizacao" type="text" placeholder="Ex: Bloco A, Pr√©dio Principal">
            </div>

            <div class="mb-3">
              <label for="descricao" class="form-label">Descri√ß√£o:</label>
              <textarea class="form-control" id="descricao" name="descricao" rows="3" placeholder="Ex: Laborat√≥rio de inform√°tica com 30 PCs."></textarea>
            </div>

            <div class="mb-3">
              <label for="recursos" class="form-label">Recursos:</label>
              <input class="form-control" id="recursos" name="recursos" type="text" placeholder="Ex: Projetor, Quadro Branco, Ar Condicionado">
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-coreui-dismiss="modal">Fechar</button>
            <button class="btn save-btn" type="submit">Salvar Sala</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalDetalhesSala" tabindex="-1" aria-labelledby="modalDetalhesSalaLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="modalDetalhesSalaLabel"><span id="detalheNomeModal"></span></h5>
          <button class="btn-close" type="button" data-coreui-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <p><strong>Nome:</strong> <span id="detalheNome"></span></p>
          <p><strong>Descri√ß√£o:</strong> <span id="detalheDescricao"></span></p>
          <p><strong>Capacidade:</strong> <span id="detalheCapacidade"></span></p>
          <p><strong>Recursos:</strong> <span id="detalheRecursos"></span></p>
          <p><strong>Localiza√ß√£o:</strong> <span id="detalheLocalizacao"></span></p>
        </div>

        <div class="modal-footer">
          {% if tipo_usuario == 'ADMINISTRADOR' %}
          <button class="btn edt-btn" id="btnEditarSala">Editar</button>
          <button class="btn exc-btn" id="btnExcluirSala">Excluir</button>
          {% endif %}
          <button class="btn btn-secondary" type="button" data-coreui-dismiss="modal">Fechar</button>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEdicaoSala" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="formEdicaoSala">
          <div class="modal-header">
            <h5 class="modal-title">‚úèÔ∏è Editar Sala: <span id="edicaoNomeTitulo"></span></h5>
            <button class="btn-close" type="button" data-coreui-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nome:</label>
              <input class="form-control" id="editNome" name="nome" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Capacidade:</label>
              <input class="form-control" id="editCapacidade" name="capacidade" type="number" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Localiza√ß√£o:</label>
              <input class="form-control" id="editLocalizacao" name="localizacao">
            </div>

            <div class="mb-3">
              <label class="form-label">Descri√ß√£o:</label>
              <textarea class="form-control" id="editDescricao" name="descricao"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Recursos:</label>
              <input class="form-control" id="editRecursos" name="recursos">
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-coreui-dismiss="modal">Cancelar</button>
            <button class="btn save-btn" type="submit">Salvar altera√ß√µes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modalConfirmacaoExclusao" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üö´ Confirmar Exclus√£o</h5>
          <button class="btn-close" type="button" data-coreui-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja excluir a sala <strong><span id="nomeSalaExclusao"></span></strong>?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-coreui-dismiss="modal">Cancelar</button>
          <button class="btn exc-btn" id="confirmarExclusao">Excluir Permanentemente</button>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock %} 

{% block scripts %}

<script>
  // Vari√°vel global para armazenar o ID da sala ativa
  let salaAtivaId = null; 

  // Fun√ß√£o auxiliar para mostrar modais CoreUI/Bootstrap
  function showCoreUIModal(modalId) {
    const modalEl = document.getElementById(modalId);
    // Cria uma nova inst√¢ncia se n√£o existir, sen√£o usa a existente
    const modal = coreui.Modal.getInstance(modalEl) || new coreui.Modal(modalEl); 
    modal.show();
  }

  // Fun√ß√£o auxiliar para esconder modais CoreUI/Bootstrap
  function hideCoreUIModal(modalId) {
    const modalEl = document.getElementById(modalId);
    // Pega a inst√¢ncia e esconde
    const modal = coreui.Modal.getInstance(modalEl); 
    if (modal) {
      modal.hide();
    }
  }


  document.addEventListener("DOMContentLoaded", function () {
    
    const detalhesModal = document.getElementById("modalDetalhesSala");
    const btnEditarSala = document.getElementById("btnEditarSala");
    const btnExcluirSala = document.getElementById("btnExcluirSala");
    // ID corrigido no HTML unificado
    const modalExclusao = document.getElementById("modalConfirmacaoExclusao"); 
    // ID corrigido no HTML unificado
    const btnConfirmarExclusao = document.getElementById("confirmarExclusao"); 

    // -------------------------------------
    // 1. Script de Cadastro (POST /api/v1/salas)
    // -------------------------------------
    const formCadastro = document.getElementById("formCadastroSala");
    if (formCadastro) {
      formCadastro.addEventListener("submit", async function (event) {
        event.preventDefault();
        const formData = new FormData(formCadastro);
        const data = {};
        formData.forEach(
          (value, key) =>
            (data[key] = key === "capacidade" ? parseInt(value) : value || null)
        );

        try {
          const response = await fetch("/api/v1/salas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || `Erro HTTP ${response.status}`);
          }

          const result = await response.json();
          alert(`Sala "${result.nome}" cadastrada com sucesso!`);
          hideCoreUIModal("modalCadastroSala");
          window.location.reload();
        } catch (err) {
          console.error(err);
          alert("Falha no cadastro: " + (err.message || "Erro desconhecido."));
        }
      });
    }


    // -------------------------------------
    // 2. Script para o Modal de Detalhes (Armazenamento do ID e dados)
    // -------------------------------------
    if (detalhesModal) {
      detalhesModal.addEventListener("show.coreui.modal", function (event) {
        const card = event.relatedTarget; 

        // Extrai o ID e salva na vari√°vel global
        salaAtivaId = card.getAttribute("data-sala-id"); 

        // Extrai as outras informa√ß√µes
        const nome = card.getAttribute("data-sala-nome");
        const capacidade = card.getAttribute("data-sala-capacidade");
        const localizacao = card.getAttribute("data-sala-localizacao");
        const recursos = card.getAttribute("data-sala-recursos");
        const descricao = card.getAttribute("data-sala-descricao");

        // Atualiza o corpo do Modal de Detalhes
        document.getElementById("detalheNomeModal").textContent = nome;
        document.getElementById("detalheNome").textContent = nome;
        document.getElementById("detalheCapacidade").textContent = capacidade + " pessoas";
        document.getElementById("detalheLocalizacao").textContent = localizacao;
        document.getElementById("detalheRecursos").textContent = recursos;
        document.getElementById("detalheDescricao").textContent = descricao;

        // Armazena dados nos bot√µes de a√ß√£o para f√°cil acesso
        if (btnEditarSala) {
          btnEditarSala.setAttribute('data-sala-id', salaAtivaId);
          btnEditarSala.setAttribute('data-sala-nome', nome);
          btnEditarSala.setAttribute('data-sala-capacidade', capacidade);
          btnEditarSala.setAttribute('data-sala-localizacao', localizacao);
          btnEditarSala.setAttribute('data-sala-recursos', recursos);
          btnEditarSala.setAttribute('data-sala-descricao', descricao);
          
          // Abre o modal de Edi√ß√£o diretamente (se fosse a l√≥gica do Template 2)
          // No Template 1, abrimos pelo click handler
        }
        
        // Configura o nome da sala no bot√£o/modal de exclus√£o
        if (btnExcluirSala) {
            btnExcluirSala.setAttribute('data-sala-nome', nome);
            // Configura o click para abrir o modal de confirma√ß√£o do Template 1
            btnExcluirSala.onclick = () => showCoreUIModal("modalConfirmacaoExclusao");
        }
      });
    }
    
    // -------------------------------------
    // 3. Prepara√ß√£o para Exclus√£o (Abre o modal de confirma√ß√£o)
    // -------------------------------------
    if (modalExclusao) {
      modalExclusao.addEventListener("show.coreui.modal", function () {
        // Pega o nome da sala do bot√£o de Exclus√£o (que pegou do modal de detalhes)
        const nomeSala = btnExcluirSala.getAttribute('data-sala-nome');
        document.getElementById('nomeSalaExclusao').textContent = nomeSala;
        
        // Esconde o modal de detalhes (se o CoreUI n√£o o fizer automaticamente)
        hideCoreUIModal("modalDetalhesSala");
      });
    }

    // -------------------------------------
    // 4. A√ß√£o: EXCLUIR SALA (DELETE /api/v1/salas/{id})
    // -------------------------------------
    if (btnConfirmarExclusao) {
      btnConfirmarExclusao.addEventListener("click", async function() {
        if (!salaAtivaId) return;

        const nomeSala = document.getElementById('nomeSalaExclusao').textContent;
        
        try {
          const response = await fetch(`/api/v1/salas/${salaAtivaId}`, {
            method: "DELETE",
          });

          if (response.status === 204) { // Sucesso na exclus√£o (No Content)
            alert(`Sala "${nomeSala}" exclu√≠da com sucesso.`);
            hideCoreUIModal("modalConfirmacaoExclusao");
            window.location.reload();
          } else {
            const err = await response.json();
            throw new Error(err.detail || `Erro HTTP ${response.status}`); 
          }
        } catch (err) {
          console.error("Erro na exclus√£o:", err);
          alert("Falha na exclus√£o da sala: " + (err.message || "Erro desconhecido."));
          hideCoreUIModal("modalConfirmacaoExclusao"); // Fecha modal em caso de erro
        }
      });
    }

    // -------------------------------------
    // 5. A√ß√£o: EDITAR SALA (Prepara√ß√£o - Abre o modal de edi√ß√£o)
    // -------------------------------------
    if (btnEditarSala) {
      btnEditarSala.addEventListener("click", function() {
        // Esconde o modal de detalhes
        hideCoreUIModal("modalDetalhesSala");
        
        // Obt√©m os dados do pr√≥prio bot√£o
        const id = this.getAttribute('data-sala-id');
        const nome = this.getAttribute('data-sala-nome');
        const capacidade = this.getAttribute('data-sala-capacidade');
        const localizacao = this.getAttribute('data-sala-localizacao');
        const recursos = this.getAttribute('data-sala-recursos');
        const descricao = this.getAttribute('data-sala-descricao');
        
        // Preenche o Modal de Edi√ß√£o
        document.getElementById('edicaoNomeTitulo').textContent = nome;
        document.getElementById('formEdicaoSala').setAttribute('data-sala-id', id);
        
        // Preenche os inputs
        document.getElementById('editNome').value = nome;
        document.getElementById('editCapacidade').value = capacidade;
        
        // Trata strings de placeholder como valores vazios
        document.getElementById('editLocalizacao').value = (localizacao === 'N√£o Informada' ? '' : localizacao);
        document.getElementById('editRecursos').value = (recursos === 'Nenhum' ? '' : recursos);
        document.getElementById('editDescricao').value = (descricao === 'Nenhuma descri√ß√£o fornecida.' ? '' : descricao);
        
        // Mostra o modal de Edi√ß√£o
        showCoreUIModal("modalEdicaoSala");
      });
    }
    
    // -------------------------------------
    // 6. A√ß√£o: EDITAR SALA (Submiss√£o - PUT /api/v1/salas/{id})
    // -------------------------------------
    const formEdicao = document.getElementById("formEdicaoSala");
    if (formEdicao) {
      formEdicao.addEventListener("submit", async function (event) {
        event.preventDefault();
        // Pega o ID que foi setado no data-sala-id do formul√°rio
        const idParaEditar = this.getAttribute('data-sala-id'); 
        if (!idParaEditar) return alert("Erro: ID da sala n√£o encontrado para edi√ß√£o.");
        
        const formData = new FormData(formEdicao);
        const data = {};
        // O nome do input √© usado no Template 1/2 para montar o payload, √© importante manter o `name`
        formData.forEach(
          (value, key) =>
            (data[key] = key === "capacidade" ? parseInt(value) : value || null)
        );

        try {
          const response = await fetch(`/api/v1/salas/${idParaEditar}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || `Erro HTTP ${response.status}`);
          }

          const result = await response.json();
          alert(`Sala "${result.nome}" atualizada com sucesso!`);
          hideCoreUIModal("modalEdicaoSala");
          window.location.reload();
        } catch (err) {
          console.error("Erro na atualiza√ß√£o:", err);
          alert("Falha na atualiza√ß√£o da sala: " + (err.message || "Erro desconhecido."));
        }
      });
    }
  });
</script>

{% endblock %}