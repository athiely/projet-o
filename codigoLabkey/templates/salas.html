{% extends "base_dashboard.html" %}
{% block content %}
<div class="container my-5">
  <h2 class="text-center mb-4">Todas as Salas</h2>

  {% if tipo_usuario == "ADMINISTRADOR" %}
  <div class="text-end mb-4">
    <button class="btn btn-dark" data-coreui-toggle="modal" data-coreui-target="#novaSalaModal">
      Nova Sala
    </button>
  </div>
  {% endif %}

  <div id="feedback-message" class="alert alert-dismissible fade d-none" role="alert">
    <span id="feedback-text"></span>
    <button type="button" class="btn-close" onclick="document.getElementById('feedback-message').classList.add('d-none')"></button>
  </div>

  <div class="row g-4">
    {% for sala in salas %}
    <div class="col-12 col-sm-6 col-md-4">
      <div class="card sala-card text-center" data-id="{{ sala.id }}" style="cursor:pointer;">
        <div class="card-body">
          <h5 class="card-title">{{ sala.nome }}</h5>
        </div>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info w-75 text-center mx-auto">
      Nenhuma sala cadastrada.
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal de detalhes -->
<div class="modal fade" id="salaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="salaModalNome"></h5>
        <button type="button" class="btn-close btn-close-white" data-coreui-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>ID:</strong> <span id="salaModalId"></span></p>
        <p><strong>Capacidade:</strong> <span id="salaModalCapacidade"></span></p>
        <p><strong>Recursos:</strong> <span id="salaModalRecursos"></span></p>
        <p><strong>Descrição:</strong> <span id="salaModalDescricao"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal nova sala -->
<div class="modal fade" id="novaSalaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Cadastrar Nova Sala</h5>
        <button type="button" class="btn-close btn-close-white" data-coreui-dismiss="modal"></button>
      </div>
      <form id="formNovaSala">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" name="nome" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descrição</label>
            <textarea class="form-control" name="descricao" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Capacidade</label>
            <input type="number" class="form-control" name="capacidade" min="1" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Recursos</label>
            <input type="text" class="form-control" name="recursos">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const salaModal = new coreui.Modal(document.getElementById("salaModal"));
const novaSalaModal = new coreui.Modal(document.getElementById("novaSalaModal"));

function showFeedback(msg, type='success'){
  const div = document.getElementById("feedback-message");
  const text = document.getElementById("feedback-text");
  div.className = `alert alert-${type} alert-dismissible fade show mt-3`;
  text.textContent = msg;
  setTimeout(() => div.classList.add('d-none'), 4000);
}

// Abrir modal com detalhes
document.querySelectorAll('.sala-card').forEach(card => {
  card.addEventListener('click', async () => {
    const id = card.dataset.id;
    const res = await fetch(`/api/v1/salas/${id}`);
    if (!res.ok) return showFeedback('Erro ao carregar detalhes', 'danger');
    const sala = await res.json();
    document.getElementById('salaModalNome').textContent = sala.nome;
    document.getElementById('salaModalId').textContent = sala.id;
    document.getElementById('salaModalCapacidade').textContent = sala.capacidade;
    document.getElementById('salaModalRecursos').textContent = sala.recursos || 'Nenhum';
    document.getElementById('salaModalDescricao').textContent = sala.descricao || 'Sem descrição';
    salaModal.show();
  });
});

// Cadastrar nova sala
document.getElementById('formNovaSala')?.addEventListener('submit', async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  const res = await fetch('/api/v1/salas', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  const result = await res.json();
  if (!res.ok) return showFeedback(result.detail || 'Erro ao cadastrar', 'danger');
  novaSalaModal.hide();
  showFeedback('Sala cadastrada com sucesso!');
  setTimeout(() => location.reload(), 1000);
});
</script>
{% endblock %}
