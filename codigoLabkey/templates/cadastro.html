{% extends "authBase.html" %}
{% block title %}Cadastro - LabKey{% endblock %}

{% block auth_content %}
<div class="form-container">
  <div class="auth-txt">
    <h1>Cadastre-se</h1>
    <p>Comece agora a realizar suas reservas</p>
    <div id="feedback-message" class="mt-3"></div>
  </div>

  <form id="cadastro-form">
    <div class="mb-3">
      <label for="nome" class="form-label">Nome</label>
      <input type="text" class="form-control" id="nome" name="nome" required />
    </div>

    <div class="mb-3">
      <label for="email" class="form-label">Endereço de Email</label>
      <input type="email" class="form-control" id="email" name="email" required />
    </div>

    <div class="row">
      <div class="mb-3 col-md-6">
        <label for="senha" class="form-label">Senha</label>
        <input type="password" class="form-control" id="senha" name="senha" required />
      </div>

      <div class="mb-3 col-md-6">
        <label for="tipo" class="form-label">Perfil de usuário</label>
        <select class="form-select" id="tipo" name="tipo" required>
          <option value="" selected disabled>Selecione seu perfil</option>
          <option value="COMUM">Comum</option>
          <option value="ADMINISTRADOR">Administrador</option>
        </select>
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100" id="cadastro-btn">Cadastrar</button>

    <p class="mt-3 text-center">
      Já tem conta? <a href="/login">Faça Login</a>
    </p>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_BASE = "/api/v1";

function showFeedback(message, type = "success") {
  const feedbackDiv = document.getElementById("feedback-message");
  const alertClass = type === "success" ? "alert-success" : "alert-danger";
  feedbackDiv.innerHTML = `<div class="alert-custom ${alertClass}" role="alert">${message}</div>`;
}

async function handleCadastroSubmit(e) {
  e.preventDefault();
  const form = e.target;
  const btn = document.getElementById("cadastro-btn");

  const data = {
    nome: form.nome.value,
    email: form.email.value,
    senha: form.senha.value,
    tipo: form.tipo.value
  };

  btn.disabled = true;
  btn.textContent = "Aguarde...";

  try {
    const response = await fetch(`${API_BASE}/cadastro`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    if (response.ok) {
      showFeedback(result.mensagem, "success");
      setTimeout(() => window.location.href = result.redirect, 1000);
    } else {
      showFeedback(result.detail || "Erro ao cadastrar.", "danger");
    }
  } catch {
    showFeedback("Falha ao conectar com o servidor.", "danger");
  } finally {
    btn.disabled = false;
    btn.textContent = "Cadastrar";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("cadastro-form").addEventListener("submit", handleCadastroSubmit);
});
</script>
{% endblock %}
